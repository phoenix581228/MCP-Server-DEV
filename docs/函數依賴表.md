# BigDipper AI剪輯系統 - 函數依賴表

## 核心模組依賴關係

### 1. BigDipper MCP Server Layer (gemini_mcp_server.py)

#### 主要函數與依賴關係

```
analyze_single_video() [CRITICAL - 修復目標]
├── genai.GenerativeModel.generate_content()
├── json.loads() [問題源頭]
└── 依賴模組：
    ├── google.generativeai
    ├── json (標準庫)
    └── logging

batch_analyze_videos() 
├── analyze_single_video() [依賴上述]
├── asyncio.gather()
└── 依賴模組：
    ├── asyncio
    └── pathlib

setup_authentication()
├── genai.configure()
├── genai.GenerativeModel()
└── 依賴模組：
    ├── os (環境變數)
    └── google.generativeai
```

### 2. 新增：智能JSON提取模組 (json_extractor.py)

#### 函數依賴設計

```
extract_json_from_response() [新函數 - 核心解決方案]
├── re.search() [尋找JSON區塊]
├── json.loads() [解析提取的JSON]
└── validate_extracted_data() [數據驗證]

validate_extracted_data()
├── 必要欄位檢查
├── 數據類型驗證
└── 結構完整性確認

fallback_structure_generator() [當解析失敗時的後備]
├── 提取關鍵資訊片段
├── 基礎結構生成
└── 標記為需要手動審核
```

### 3. 語義匹配引擎 (semantic_matcher.py)

#### 函數依賴設計

```
initialize_semantic_model()
├── sentence_transformers.SentenceTransformer()
└── 依賴模組：
    ├── sentence_transformers
    └── torch

vectorize_text_content()
├── text_preprocessing()
├── model.encode()
└── normalize_vectors()

vectorize_video_metadata()
├── extract_scene_descriptions()
├── concatenate_technical_notes()
└── model.encode()

calculate_semantic_similarity()
├── cosine_similarity()
├── weighted_scoring()
└── 依賴模組：
    └── sklearn.metrics.pairwise
```

### 4. 分鏡表生成器 (storyboard_generator.py)

#### 函數依賴設計

```
generate_editing_sequence()
├── analyze_narrative_structure()
├── match_content_to_videos()
├── optimize_sequence_flow()
└── format_storyboard_output()

analyze_narrative_structure()
├── identify_story_beats()
├── extract_emotional_arc()
└── determine_pacing_requirements()

match_content_to_videos()
├── semantic_matcher.calculate_semantic_similarity()
├── apply_matching_strategies()
└── rank_candidate_clips()

optimize_sequence_flow()
├── ensure_narrative_continuity()
├── balance_technical_coverage()
└── apply_editing_principles()
```

### 5. MCP整合接口 (mcp_integration.py)

#### 函數依賴設計

```
handle_storyboard_generation_request()
├── validate_input_parameters()
├── coordinate_processing_pipeline()
└── format_mcp_response()

coordinate_processing_pipeline()
├── json_extractor.extract_json_from_response()
├── semantic_matcher.vectorize_content()
├── storyboard_generator.generate_editing_sequence()
└── error_handling_wrapper()
```

## 跨模組依賴矩陣

| 模組/函數 | gemini_mcp_server | json_extractor | semantic_matcher | storyboard_generator | mcp_integration |
|----------|-------------------|----------------|------------------|---------------------|-----------------|
| gemini_mcp_server.analyze_single_video | - | ✓ (新增依賴) | ✗ | ✗ | ✗ |
| json_extractor.extract_json_from_response | ✗ | - | ✗ | ✗ | ✗ |
| semantic_matcher.* | ✗ | ✗ | - | ✗ | ✗ |
| storyboard_generator.match_content_to_videos | ✗ | ✗ | ✓ | - | ✗ |
| mcp_integration.coordinate_processing_pipeline | ✓ | ✓ | ✓ | ✓ | - |

## 修復實施順序

### 第一階段：緊急修復 (Week 1)
1. **json_extractor.py** - 獨立模組，無外部依賴
2. **修改 analyze_single_video()** - 最小變更，向後兼容
3. **測試JSON解析** - 驗證39支影片數據

### 第二階段：功能擴展 (Week 2-3)
4. **semantic_matcher.py** - 依賴sentence-transformers
5. **storyboard_generator.py** - 依賴semantic_matcher
6. **集成測試** - 端到端流程驗證

### 第三階段：系統整合 (Week 4)
7. **mcp_integration.py** - 統一接口封裝
8. **BigDipper整合** - MCP Server升級
9. **性能優化** - 批次處理和緩存

## 關鍵依賴關係說明

### 外部套件依賴
- **google.generativeai**: Gemini API接入
- **sentence-transformers**: 語義向量化
- **scikit-learn**: 相似度計算
- **pandas**: 數據處理
- **asyncio**: 非同步處理

### 內部模組耦合度
- **低耦合**: json_extractor (獨立)
- **中耦合**: semantic_matcher, storyboard_generator
- **高耦合**: mcp_integration (協調中心)

### 風險評估
- **單點故障**: gemini_mcp_server.analyze_single_video
- **新增風險**: sentence-transformers模型加載
- **性能瓶頸**: 大量影片的向量計算

此依賴表確保了修復方案的系統性和可維護性，支援逐步實施和向後兼容。