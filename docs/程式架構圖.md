# BigDipper AI剪輯系統 - 程式架構圖

## 五層系統架構設計

### 架構總覽圖

```
┌─────────────────────────────────────────────────────────────────┐
│                    Layer 5: 用戶接口層                           │
│  ┌─────────────────┬─────────────────┬─────────────────────────┐ │
│  │   Claude Code   │   Web Interface │    REST API Endpoints   │ │
│  │      CLI        │                 │                         │ │
│  └─────────────────┴─────────────────┴─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                 ↕
┌─────────────────────────────────────────────────────────────────┐
│                    Layer 4: MCP整合層                            │
│  ┌─────────────────┬─────────────────┬─────────────────────────┐ │
│  │  MCP Server     │   Tool Registry │    Session Management   │ │
│  │   Protocol      │                 │                         │ │
│  └─────────────────┴─────────────────┴─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                 ↕
┌─────────────────────────────────────────────────────────────────┐
│                   Layer 3: 核心業務邏輯層                         │
│  ┌─────────────────┬─────────────────┬─────────────────────────┐ │
│  │  AI剪輯引擎     │   語義匹配引擎   │    分鏡表生成器          │ │
│  │ EditingEngine   │ SemanticMatcher │  StoryboardGenerator    │ │
│  └─────────────────┴─────────────────┴─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                 ↕
┌─────────────────────────────────────────────────────────────────┐
│                   Layer 2: 數據處理層                            │
│  ┌─────────────────┬─────────────────┬─────────────────────────┐ │
│  │ JSON數據解析器   │   向量化引擎     │    場記數據處理器        │ │
│  │ JSONExtractor   │ VectorEngine    │  MetadataProcessor      │ │
│  └─────────────────┴─────────────────┴─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                 ↕
┌─────────────────────────────────────────────────────────────────┐
│                   Layer 1: AI模型層                              │
│  ┌─────────────────┬─────────────────┬─────────────────────────┐ │
│  │  Gemini 2.5 Pro │      Claude     │  sentence-transformers │ │
│  │   (場記分析)     │   (序列生成)     │     (語義向量化)         │ │
│  └─────────────────┴─────────────────┴─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 詳細模組架構

### Layer 1: AI模型層 (Foundation Models)

```
┌─────────────────────────────────────────────────────────────────┐
│                         AI模型層                                 │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  Gemini 2.5 Pro │      Claude     │   sentence-transformers    │
│                 │                 │                             │
│ • 影片場記分析   │ • 分鏡表生成     │ • 文本向量化                │
│ • 技術參數識別   │ • 序列優化       │ • 語義相似度計算            │
│ • 場景描述       │ • 創意建議       │ • 多語言支援                │
│                 │                 │                             │
│ Input: Video    │ Input: Text +   │ Input: Text                 │
│ Output: JSON    │ Context         │ Output: Vectors             │
│                 │ Output: Story   │                             │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

### Layer 2: 數據處理層 (Data Processing)

```
┌─────────────────────────────────────────────────────────────────┐
│                      數據處理層                                  │
├─────────────────┬─────────────────┬─────────────────────────────┤
│ JSONExtractor   │ VectorEngine    │  MetadataProcessor          │
│                 │                 │                             │
│ • 智能JSON提取   │ • 批次向量化     │ • 場記數據清洗              │
│ • 格式驗證       │ • 相似度計算     │ • 時間軸標準化              │
│ • 錯誤修復       │ • 索引建立       │ • 技術參數萃取              │
│ • 結構標準化     │ • 檢索優化       │ • 品質評估                  │
│                 │                 │                             │
│ extract_json_   │ vectorize_      │ process_metadata()          │
│ from_response() │ content()       │ standardize_timeline()      │
│ validate_data() │ build_index()   │ extract_tech_params()       │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

### Layer 3: 核心業務邏輯層 (Core Business Logic)

```
┌─────────────────────────────────────────────────────────────────┐
│                    核心業務邏輯層                                │
├─────────────────┬─────────────────┬─────────────────────────────┤
│ EditingEngine   │ SemanticMatcher │  StoryboardGenerator        │
│                 │                 │                             │
│ • 剪輯邏輯引擎   │ • 語義匹配演算   │ • 分鏡序列生成              │
│ • 節奏分析       │ • 多重匹配策略   │ • 創意優化                  │
│ • 轉場設計       │ • 上下文理解     │ • 輸出格式化                │
│ • 品質控制       │ • 權重計算       │ • 專業建議                  │
│                 │                 │                             │
│ analyze_rhythm()│ calculate_      │ generate_sequence()         │
│ design_trans-   │ similarity()    │ optimize_flow()             │
│ itions()        │ apply_context() │ format_output()             │
│ quality_check() │ weight_scores() │ add_suggestions()           │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

### Layer 4: MCP整合層 (Integration Layer)

```
┌─────────────────────────────────────────────────────────────────┐
│                     MCP整合層                                    │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  MCP Server     │   Tool Registry │    Session Management      │
│   Protocol      │                 │                             │
│                 │                 │                             │
│ • 協議實作       │ • 工具註冊       │ • 會話狀態管理              │
│ • 請求路由       │ • 功能暴露       │ • 錯誤處理                  │
│ • 回應格式化     │ • 權限控制       │ • 效能監控                  │
│ • 版本管理       │ • API文檔        │ • 資源管理                  │
│                 │                 │                             │
│ handle_request()│ register_tool() │ manage_session()            │
│ route_command() │ expose_api()    │ handle_errors()             │
│ format_response│ control_access()│ monitor_performance()       │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

### Layer 5: 用戶接口層 (User Interface)

```
┌─────────────────────────────────────────────────────────────────┐
│                     用戶接口層                                   │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   Claude Code   │   Web Interface │    REST API Endpoints      │
│      CLI        │                 │                             │
│                 │                 │                             │
│ • 命令列介面     │ • 視覺化操作     │ • RESTful API               │
│ • 互動式操作     │ • 即時預覽       │ • 第三方整合                │
│ • 腳本自動化     │ • 拖拽介面       │ • Webhook支援               │
│ • 批次處理       │ • 進度顯示       │ • 開發者工具                │
│                 │                 │                             │
│ claude-code     │ web-dashboard   │ /api/v1/storyboard          │
│ integration     │ interface       │ /api/v1/analyze             │
│                 │                 │ /api/v1/status              │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

## 數據流向圖

### 主要數據流

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   新聞文章       │    │   場記JSON       │    │   分析報告       │
│   Article.md    │    │   Metadata.json │    │   Report.md     │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Layer 2: 數據處理層                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │文本預處理   │  │JSON解析修復│  │場記數據標準化           │ │
│  └─────┬───────┘  └─────┬───────┘  └─────────┬───────────────┘ │
└────────┼──────────────────┼──────────────────────┼─────────────┘
         │                  │                      │
         ▼                  ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Layer 3: 核心業務邏輯層                         │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │語義向量化   │  │場景匹配     │  │分鏡序列生成             │ │
│  └─────┬───────┘  └─────┬───────┘  └─────────┬───────────────┘ │
└────────┼──────────────────┼──────────────────────┼─────────────┘
         │                  │                      │
         └─────────┬────────┴───────┬──────────────┘
                   ▼                ▼
         ┌─────────────────┐  ┌─────────────────┐
         │  分鏡表PDF      │  │  EDL時間軸      │
         │  Storyboard.pdf │  │  Timeline.edl   │
         └─────────────────┘  └─────────────────┘
```

### 錯誤處理流

```
┌─────────────────┐
│   輸入錯誤       │
│   Invalid Input │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐    YES   ┌─────────────────┐
│   數據驗證       │ ────────▶│   自動修復       │
│   Validation    │          │   Auto Repair   │
└─────────┬───────┘          └─────────┬───────┘
          │                            │
          │ NO                         ▼
          ▼                  ┌─────────────────┐
┌─────────────────┐          │   回退方案       │
│   錯誤記錄       │          │   Fallback      │
│   Error Log     │          └─────────┬───────┘
└─────────┬───────┘                    │
          │                            │
          ▼                            ▼
┌─────────────────┐          ┌─────────────────┐
│   使用者通知     │          │   部分結果輸出   │
│   User Alert    │          │   Partial Output│
└─────────────────┘          └─────────────────┘
```

## 關鍵設計原則

### 1. 模組化設計
- **低耦合**：各層間依賴最小化
- **高內聚**：單一職責原則
- **可插拔**：支援組件替換

### 2. 錯誤韌性
- **多重備援**：每個關鍵功能都有備選方案
- **漸進降級**：部分失敗不影響整體系統
- **自動恢復**：智能錯誤檢測和修復

### 3. 擴展性
- **水平擴展**：支援多實例部署
- **垂直擴展**：支援更強大的AI模型
- **功能擴展**：新功能模組化添加

### 4. 效能優化
- **非同步處理**：避免阻塞操作
- **快取機制**：減少重複計算
- **批次處理**：提高吞吐量

此架構確保系統的可靠性、可維護性和可擴展性，支援從POC到生產環境的平滑升級。